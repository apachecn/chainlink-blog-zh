# å¦‚ä½•åˆ›å»ºä¸€ä¸ª NFT æ¸¸æˆ

> åŸæ–‡:[https://blog.chain.link/how-to-create-an-nft-game/](https://blog.chain.link/how-to-create-an-nft-game/)

åœ¨æœ¬æ•™ç¨‹ä¸­ï¼Œæˆ‘ä»¬å°†æ„å»ºä¸€ä¸ªåŸºäº NFT çš„ Web3â€œæ¸¸æˆâ€æˆ‘è¯´çš„â€œæ¸¸æˆâ€æ˜¯æŒ‡ä¸€ä¸ª 100%å‚¨å­˜åœ¨åŒºå—é“¾ä¸Šçš„ç”µå­é¸¡ä¸€æ ·çš„ dAppã€‚

æˆ‘ä»¬å°†åœ¨åŒºå—é“¾å‚¨å­˜æ‰€æœ‰èµ„äº§å’Œä¸€åˆ‡å…³äº dApp çš„ä¸œè¥¿ã€‚è®©æˆ‘ä»¬æ¥çœ‹çœ‹æˆ‘ä»¬å°†æ„å»ºä»€ä¹ˆã€‚dApp çš„ web åº”ç”¨ç¨‹åºéƒ¨åˆ†éå¸¸ç®€å•ã€‚å®ƒä¼šè®©æˆ‘ä»¬æ¥è§¦åˆ°æˆ‘ä»¬çš„è¡¨æƒ…ç¬¦å·ã€‚

![Image of an emoji NFT on blue background](../Images/123dae0914b5dfd69165a8c8fba14847.png)

## èµ·å§‹é¡¹ç›®æ–‡ä»¶

ä½ å¯ä»¥åœ¨è¿™é‡Œ æ‰¾åˆ°è¿™ä¸ªé¡¹ç›®çš„é¦–å‘ [ã€‚](https://github.com/smartcontractkit/smart-contract-examples/tree/main/EmojiGotchi)

å®ƒåˆ†æˆäº†ä¸‰ä¸ªä¸åŒçš„åˆ†æ”¯ã€‚é¦–å…ˆï¼Œæˆ‘ä»¬å°†åœ¨ä¸»åˆ†æ”¯ã€‚è¿™æ˜¯å¼€å§‹çš„æœ€å¥½åœ°æ–¹ã€‚å›è´­è¢«åˆ†ä¸ºä¸‰ä¸ªä¸åŒçš„åˆ†æ”¯ï¼Œä¸€æ—¦æˆ‘ä»¬å»ºç«‹äº†åˆåŒï¼Œä»£ç åº”è¯¥åŒ¹é…é“¸é€ åˆ†æ”¯ã€‚ä¸€æ—¦æ„å»ºå‡ºå®Œæ•´çš„åº”ç”¨ç¨‹åºï¼Œå®ƒåº”è¯¥ä¸æœ€ç»ˆçš„åˆ†æ”¯ç›¸åŒã€‚è¿™ä¸ªåˆ†æ”¯å­˜æ”¾å®Œæ•´çš„åº”ç”¨ç¨‹åºã€‚

æˆ‘ä»¬å°†ä½¿ç”¨ [ä»£å·¥å‚](https://book.getfoundry.sh/getting-started/installation.html) ã€‚Foundry æ˜¯ä»¥å¤ªåŠå¼€å‘çš„æ–°å·¥å…·åŒ…ã€‚Foundry å¾ˆå¿«ï¼Œæµ‹è¯•å†™çš„å¾ˆæ‰å®ã€‚ç¼–å†™æµ‹è¯•æ—¶ä¸å¿…åœ¨ Javascript å’Œ Solidity ä¹‹é—´åˆ‡æ¢ä¸Šä¸‹æ–‡ï¼Œè¿™æœ‰åŠ©äºè·å¾—è‰¯å¥½çš„ç”¨æˆ·ä½“éªŒï¼Œè€Œä¸”å¥‘çº¦ä»£ç éå¸¸æ£’ï¼

æ‚¨å¯ä»¥åœ¨æ–‡æ¡£ä¸­æ‰¾åˆ°é“¸é€ å‚ [çš„å®‰è£…è¯´æ˜ã€‚](https://book.getfoundry.sh/getting-started/installation.html)

ä½ ä¹Ÿå°†åœ¨å‰ç«¯ä½¿ç”¨ SvelteKitã€‚æˆ‘æ˜¯ SvelteKit çš„ç²‰ä¸ï¼Œå› ä¸ºå®ƒå¾ˆå®¹æ˜“è§£é‡Šå‘ç”Ÿäº†ä»€ä¹ˆã€‚ä½ ä¼šæ¥è§¦åˆ°ä¸€ç‚¹ç‚¹â€œè‹—æ¡çš„é­”åŠ›â€ï¼Œä½†æ€»çš„æ¥è¯´ï¼Œè¿™æ˜¯ä¸€ä¸ªéå¸¸ç®€å•çš„èµ·ç‚¹ã€‚è®©æˆ‘ä»¬å¼€å§‹å§ã€‚

è¯¥é¡¹ç›®è¢«è®¾å®šä¸ºå•ä¸€å›è´­ã€‚æœ‰ä¸¤ä¸ªå­æ–‡ä»¶å¤¹ï¼Œ `foundry` å’Œ `svelte` ï¼Œå¦‚æœä½ é€‰æ‹©ä½¿ç”¨é‚£ä¸ªç¼–è¾‘å™¨ï¼Œè¿˜æœ‰ä¸€ç‚¹ VS ä»£ç çš„é­”åŠ›ã€‚å·¥ä½œå°æ ‡é¢˜æ å°†æ ¹æ®æ‚¨æ‰€åœ¨çš„é¡¹ç›®éƒ¨åˆ†è¿›è¡Œç€è‰²ã€‚

å½“æ¯”è¾ƒ Foundry å’Œ SvelteKit çš„åŸºæœ¬å®‰è£…æ—¶ï¼Œæˆ‘è®¾ç½®äº†ä¸€äº›é¢å¤–çš„å·¥å…·ã€‚

```
deploy.sh

#!/usr/bin/env bash

# Read the Mumbai RPC URL
echo Enter Your Mumbai RPC URL:
echo Example: "https://polygon-mumbai.g.alchemy.com/v2/XXXXXXXXXX"
read -s rpc

# Read the contract name
echo Which contract do you want to deploy \(eg Greeter\)?
read contract

forge create ./src/${contract}.sol:${contract} -i --rpc-url $rpc
```

è¿™å°†å…è®¸æ‚¨å°†æˆ‘ä»¬çš„åˆåŒéƒ¨ç½²åˆ°å­Ÿä¹°ï¼Œæ‰€æœ‰è¿™äº›éƒ½æ˜¯è¯»å–å˜é‡ï¼Œè€Œä¸æ˜¾ç¤ºæ‚¨åœ¨å‘½ä»¤è¡Œä¸Šé”®å…¥çš„å†…å®¹ã€‚è¿™å°†ç¡®ä¿æ‚¨çš„ç§é’¥ä¸ä¼šå­˜å‚¨åœ¨æ‚¨çš„å‘½ä»¤è¡Œå†å²ä¸­ã€‚

```
remappings.txt

@openzeppelin/=lib/openzeppelin-contracts/

ds-test/=lib/ds-test/src/ 
```

è¿™ä¸ªé‡æ˜ å°„æ–‡ä»¶å…è®¸ä½ ä½¿ç”¨åƒ OpenZeppelin å¥‘çº¦è¿™æ ·çš„ä¸œè¥¿ï¼Œå¹¶ä»¥ä½ é€šå¸¸ä½¿ç”¨å…¶ä»–å·¥å…·å¦‚ Hardhat æˆ– Remix çš„æ–¹å¼å¯¼å…¥å®ƒä»¬ã€‚è¯¥æ–‡ä»¶å°†å¯¼å…¥é‡æ–°æ˜ å°„åˆ°å®ƒä»¬æ‰€åœ¨çš„ç›®å½•ã€‚æˆ‘è¿˜é€šè¿‡ `forge install openzeppelin/openzeppelin-contracts` å®‰è£…äº† OpenZeppelin åˆåŒï¼Œè¿™äº›å°†ç”¨äºåˆ›å»º ERC-721 åˆåŒã€‚

## å¼€å§‹æ„å»º dApp

### EmojiGotchi æˆªå›¾

è®©æˆ‘ä»¬å†æ¥çœ‹çœ‹è¡¨æƒ…ç¬¦å·ã€‚è¿™é‡Œæœ‰ä¸€äº›äº‹æƒ…éœ€è¦è€ƒè™‘ã€‚é¦–å…ˆï¼Œå›¾åƒæ˜¯å­˜å‚¨åœ¨é“¾ä¸Šçš„ SVGã€‚ä½ éœ€è¦è¿½è¸ªä¸€äº›ä¸åŒçš„ä»·å€¼è§‚:é¥¥é¥¿ã€å……å®å’Œå¹¸ç¦ã€‚ä½ æœ‰ä¸¤ä»¶ä¸åŒçš„äº‹æƒ…å¯ä»¥åš:ä½ å¯ä»¥å–‚å®ƒï¼Œå’Œå®ƒä¸€èµ·ç©ã€‚è®©æˆ‘ä»¬å‰”é™¤ä¸€äº›æµ‹è¯•ã€‚å¦‚æœæ‚¨åœ¨ Foundry ç›®å½•ä¸­æŸ¥æ‰¾ï¼Œæ‚¨æœ‰æ‚¨çš„ `src` ç›®å½•ï¼Œå¹¶ä¸”åœ¨ `src` ä¸­ï¼Œæ‚¨æœ‰å‡ ä¸ªä¸œè¥¿ã€‚

Foundry ä¸ºæˆ‘ä»¬æä¾›äº†åŸºæœ¬çš„åˆåŒå’Œæµ‹è¯•ã€‚è¿™ä½¿æˆ‘ä»¬èƒ½å¤Ÿè¿è¡Œ `forge test` ã€‚

Forge æ˜¯ Foundry å†…éƒ¨çš„å‘½ä»¤ä¹‹ä¸€ã€‚å½“æˆ‘ä»¬è¿è¡Œ `forge test` æ—¶ï¼Œå®ƒç¼–è¯‘æˆ‘ä»¬çš„å¥‘çº¦å¹¶è¿è¡Œæˆ‘ä»¬çš„æµ‹è¯•ï¼Œæ‚¨å¯ä»¥çœ‹åˆ°æˆ‘ä»¬çš„æµ‹è¯•é€šè¿‡äº†ã€‚

```
â¯ foundry (main) âœ˜ forge test

[â ’] Compiling...
No files changed, compilation skipped

Running 1 test for src/test/Contract.t.sol:ContractTest
[PASS] testExample() (gas: 190)
Test result: ok. 1 passed; 0 failed; finished in 222.21Âµs
â¯ foundry (main) âœ˜ 
```

è¿™ä¹Ÿè¯´æ˜ä½ å·²ç»æ­£ç¡®å®‰è£…äº† Foundryï¼Œä½ å¯ä»¥ç»§ç»­æ„å»ºå‡ºåˆçº¦ã€‚

æˆ‘ä»¬ç»§ç»­æ·»åŠ ä¸€ä¸ªæ–°æ–‡ä»¶ï¼Œ `EmojiGotchi.t.sol` ã€‚ t è¡¨ç¤ºè¿™æ˜¯ä¸€ä¸ªæµ‹è¯•ã€‚

```
src/test/EmojiGotchi.t.sol // SPDX-License-Identifier: UNLICENSED
pragma solidity 0.8.13;

import "../EmojiGotchi.sol";
import "ds-test/test.sol";

contract EmojiGotchiTest is DSTest {
 EmojiGotchi public eg;

  function setUp() public {}

Â Â Â Â function testExample() public {
Â Â Â Â Â Â Â Â assertTrue(true);
Â Â Â Â }

} 
```

æ‚¨æ­£åœ¨å¯¼å…¥å°šæœªåˆ›å»ºçš„åˆåŒï¼Œä»¥åŠ `ds-test/test.sol`

 `è®©æˆ‘ä»¬ä¹Ÿåœ¨ `src` ç›®å½•ä¸­åˆ›å»º `EmojiGotchi.sol` ã€‚æ‚¨å¯ä»¥å°†å…¶åˆ›å»ºä¸ºç©ºåˆåŒï¼Œä»¥ç¡®ä¿ä¸€åˆ‡æ­£å¸¸ã€‚

```
src/EmojiGotchi.sol

// SPDX-License-Identifier: UNLICENSED
pragma solidity 0.8.13;

contract EmojiGotchi {}
```

æˆ‘ä»¬å·²ç»å®Œæˆäº†æµ‹è¯•ã€‚å®ƒè¿˜ä¸èƒ½æµ‹è¯•ä»»ä½•ä¸œè¥¿ï¼Œä½†æ˜¯å¦‚æœä½ ç»§ç»­é€šè¿‡ `forge test` è¿è¡Œå®ƒï¼Œä½ ä¼šçœ‹åˆ°ä¸¤ä¸ªæµ‹è¯•ä¾‹å­ã€‚è¿™è®©æˆ‘ä»¬çŸ¥é“ä¸€åˆ‡éƒ½å·²è®¾ç½®å¥½å¹¶åœ¨å·¥ä½œã€‚

```
â¯ foundry (main) âœ˜ forge test

[â ¢] Compiling...
Compiler run successful

Running 1 test for src/test/EmojiGotchi.t.sol:EmojiGotchiTest
[PASS] testExample() (gas: 212)
Test result: ok. 1 passed; 0 failed; finished in 1.85ms

Running 1 test for src/test/Contract.t.sol:ContractTest
[PASS] testExample() (gas: 190)
Test result: ok. 1 passed; 0 failed; finished in 1.85ms

â¯ foundry (main) âœ˜
```

### æ¸…ç†

æ­¤æ—¶ï¼Œæ‚¨å¯ä»¥æ¸…ç† `Contract.sol` å¥‘çº¦å¹¶è¿›è¡Œæµ‹è¯•ã€‚

åˆ é™¤ `src/Contract.sol` å’Œ `src/test/Contract.t.sol`

### ç¼–å†™ç¬¬ä¸€ä¸ªçœŸé¢˜

ä½ å·²ç»å¾—åˆ°äº†ä½ çš„æµ‹è¯•æ–‡ä»¶ `Contract.t.sol` ï¼Œå…¶ä¸­æœ‰ä¸€ä¸ªæµ‹è¯•æ¥ç¡®ä¿çœŸå®æ˜¯çœŸå®çš„ã€‚å½“æ‚¨è¿è¡Œå®ƒæ—¶ï¼Œå®ƒç›®å‰åªæ˜¯ç¡®ä¿æˆ‘ä»¬çš„åˆåŒå¯ä»¥è¢«å¯¼å…¥ï¼Œå¹¶ä¸”ä¸€åˆ‡éƒ½æŒ‰é¢„æœŸè¿è¡Œã€‚

è®©æˆ‘ä»¬èŠ±ç‚¹æ—¶é—´å†æ¬¡æ€è€ƒè¡¨æƒ…ç¬¦å·ï¼Œå¹¶è®°ä¸‹æˆ‘ä»¬æƒ³è¦å®ƒåšä»€ä¹ˆã€‚è¿™å°†æä¾›æˆ‘ä»¬éœ€è¦é€šè¿‡çš„ä¸€ç³»åˆ—æµ‹è¯•ã€‚

```
- mint the EmojiGotchi NFT
- set the metadata
- pass time
- feed the EmojiGotchi 
- play with the EmojiGotchi
- change the image based on happiness
- check if upkeep is needed
- perform upkeep if needed
```

è¿™ä¸ªæµ‹è¯•åˆ—è¡¨åº”è¯¥æ¶µç›–è¡¨æƒ…ç¬¦å·çš„åŸºæœ¬åŠŸèƒ½ã€‚å¦‚æœä½ å¤´å› `src/test/EmojiGotchi.t.sol` ï¼Œä½ å°±å¯ä»¥è‚‰å‡ºç¬¬ä¸€ä¸ªæµ‹è¯• `testMint()` ã€‚

```
src/test/EmojiGotchi.t.sol

// SPDX-License-Identifier: UNLICENSED
pragma solidity 0.8.13;

import "../EmojiGotchi.sol";
import "ds-test/test.sol";

contract EmojiGotchiTest is DSTest {
Â Â Â Â EmojiGotchi public eg; 
Â Â Â Â function setUp() public {
 eg = new EmojiGotchi();
 address addr = 0x1234567890123456789012345678901234567890;
 eg.safeMint(addr);
}

function testMint() public {
 address addr = 0x1234567890123456789012345678901234567890;
 address owner = eg.ownerOf(0);
 assertEq(addr, owner);
}

}
```

æ‚¨å°†éœ€è¦ä¿®æ”¹ `setUp()` åŠŸèƒ½ã€‚è¯¥å‡½æ•°åœ¨æ¯æ¬¡æµ‹è¯•ä¹‹å‰è¿è¡Œï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå®é™…çš„é“¸å¸å°†å‘ç”Ÿåœ¨ `setUp()` å‡½æ•°ä¸­ã€‚

åœ¨ `testMint()` å‡½æ•°ä¸­ï¼Œæ‚¨å¯ä»¥éªŒè¯æ‚¨åœ¨ `setUp()` å‡½æ•°ä¸­åˆ›å»ºäº†ä¸€ä¸ª NFTï¼Œå¹¶å°†å…¶åˆ†é…ç»™äº†é¢„æœŸçš„æ‰€æœ‰è€…ã€‚

å¦‚æœæ‚¨è¿™æ ·è¿è¡Œï¼Œæ‚¨å°†ä¼šçœ‹åˆ°ä¸€ä¸ªé”™è¯¯ã€‚

```
Error: 
 0: Compiler run failed
TypeError: Member "safeMint" not found or not visible after argument-dependent lookup in contract EmojiGotchi.
Â Â Â Â Â Â Â Â --> /Users/rg/Development/EmojiGotchi/foundry/src/test/EmojiGotchi.t.sol:13:9:
Â Â Â Â Â Â Â Â Â |
13 | eg.safeMint(addr);
Â Â Â Â Â Â Â Â Â | ^^^^^^^^^^^
```

è¿™æ˜¯æ„æ–™ä¹‹ä¸­çš„ï¼Œå› ä¸ºæˆ‘ä»¬è¿˜æ²¡æœ‰åœ¨æˆ‘ä»¬çš„ `EmojiGotchi.sol` åˆåŒä¸­åŠ å…¥ä»»ä½•ä¸œè¥¿ã€‚

ã€NFTs çš„ä¸€ä¸ªå¾ˆå¥½çš„èµ·ç‚¹æ˜¯[OpenZeppelin Wizard](https://docs.openzeppelin.com/contracts/4.x/wizard)ï¼Œå®ƒæä¾›äº†ä¸€ä¸ªè¡Œä¸šæ ‡å‡†çš„æ¡†æ¶ã€‚è¿™å°±æ˜¯æˆ‘ä»¬å¼€å§‹ EmojiGotchi åˆåŒçš„åœ°æ–¹ã€‚

```
src/EmojiGotchi.sol

// SPDX-License-Identifier: MIT
pragma solidity ^0.8.4;

import "@openzeppelin/contracts/token/ERC721/extensions/ERC721URIStorage.sol";
import "@openzeppelin/contracts/utils/Counters.sol";

contract EmojiGotchi is ERC721, ERC721URIStorage {
Â Â Â Â using Counters for Counters.Counter;

Â Â Â Â Counters.Counter private _tokenIdCounter;

constructor() ERC721("EmojiGotchi", "emg") {}

Â Â Â Â function safeMint(address to) public {
Â Â Â Â Â Â Â Â uint256 tokenId = _tokenIdCounter.current();
Â Â Â Â Â Â Â Â _tokenIdCounter.increment();
Â Â Â Â Â Â Â Â _safeMint(to, tokenId);
Â Â Â Â Â Â Â Â _setTokenURI(tokenId, tokenURI(tokenId));
Â Â Â Â }

Â Â Â Â // The following functions are overrides required by Solidity.

Â Â Â Â function _burn(uint256 tokenId)
Â Â Â Â Â Â Â Â internal
Â Â Â Â Â Â Â Â override(ERC721, ERC721URIStorage)
 {
Â Â Â Â Â Â Â Â super._burn(tokenId);
 }

Â Â Â Â function tokenURI(uint256 tokenId)
Â Â Â Â Â Â Â Â public
Â Â Â Â Â Â Â Â view
Â Â Â Â Â Â Â Â override(ERC721, ERC721URIStorage)
Â Â Â Â Â Â Â Â returns (string memory)
 {
Â Â Â Â Â Â Â Â return super.tokenURI(tokenId);
 } 
}
```

å¦‚æœæ‚¨ä½¿ç”¨ `forge test` é‡æ–°è¿è¡Œæ‚¨çš„æµ‹è¯•ï¼Œæ‚¨å°†çœ‹åˆ°æ‚¨å¯ä»¥æˆåŠŸåœ°é“¸é€ ä¸€ä¸ª NFTï¼

```
â¯ foundry (main) âœ˜ forge test

[â Š] Compiling...
[â †] Compiling 2 files with 0.8.13
[â ”] Solc finished in 218.31ms
Compiler run successful

Running 1 test for src/test/EmojiGotchi.t.sol:EmojiGotchiTest
[PASS] testMint() (gas: 7844)

Test result: ok. 1 passed; 0 failed; finished in 2.71ms
```

## æµ‹è¯•å…ƒæ•°æ®

ä¸‹ä¸€ä¸ªæµ‹è¯•åˆçœ‹èµ·æ¥ä¼¼ä¹å¾ˆç®€å•ï¼Œä½†ä½ å°†æ„å»ºå‡ºåˆåŒçš„ä¸€ä¸ªé‡è¦éƒ¨åˆ†ï¼Œä»¥ç¡®ä¿å®ƒæ­£å¸¸å·¥ä½œã€‚æ–°å¢ä¸€ä¸ªæµ‹è¯•: `testUri()`

```
src/test/EmojiGotchi.t.sol

function testUri() public {
(uint256 happiness, uint256 hunger, uint256 enrichment, uint256 checked, ) = eg.gotchiStats(
 0
 );
 assertEq(happiness, (hunger + enrichment) / 2);
 assertEq(hunger, 100);
 assertEq(enrichment, 100);
 assertEq(checked, block.timestamp);

}
```

è¿™ä¸ªæµ‹è¯•ä¼šæ£€æŸ¥ä½ çš„å¥‘çº¦æœ‰æ²¡æœ‰ä¸€ä¸ªåŠŸèƒ½ï¼Œ `gotchiStats` ï¼Œä¼šè¿”å›ä½ çš„ NFT çš„å¿«ä¹ï¼Œé¥¥é¥¿ï¼Œå……å®ç»Ÿè®¡ï¼ŒåŠ ä¸Šä½ ä¸Šæ¬¡æ£€æŸ¥ä½ çš„ NFTã€‚

#### å…³äº SVGs çš„æ—ç™½

å¯¹äºè¡¨æƒ…ç¬¦å·çš„å›¾åƒéƒ¨åˆ†ï¼Œæ‚¨å°†ä½¿ç”¨ SVGã€‚åœ¨å…¶åŸå§‹å½¢å¼ä¸‹ï¼Œå®ƒå°†çœ‹èµ·æ¥åƒè¿™æ ·:

```
<svg xmlns='http://www.w3.org/2000/svg' width='100%' height='100%' viewBox='0 0 800 800'>
    <rect fill='#ffffff' width='800' height='800' />
    <defs>
      <radialGradient id='a' cx='400' cy='400' r='50.1%' gradientUnits='userSpaceOnUse'>
        <stop offset='0' stop-color='#ffffff' />
        <stop offset='1' stop-color='#0EF' />
      </radialGradient>
      <radialGradient id='b' cx='400' cy='400' r='50.4%' gradientUnits='userSpaceOnUse'>
        <stop offset='0' stop-color='#ffffff' />
        <stop offset='1' stop-color='#0FF' />
      </radialGradient>
    </defs>
    <rect fill='url(#a)' width='800' height='800' />
    <g fill-opacity='0.5'>
      <path fill='url(#b)' d='M998.7 439.2c1.7-26.5 1.7-52.7 0.1-78.5L401 399.9c0 0 0-0.1 0-0.1l587.6-116.9c-5.1-25.9-11.9-51.2-20.3-75.8L400.9 399.7c0 0 0-0.1 0-0.1l537.3-265c-11.6-23.5-24.8-46.2-39.3-67.9L400.8 399.5c0 0 0-0.1-0.1-0.1l450.4-395c-17.3-19.7-35.8-38.2-55.5-55.5l-395 450.4c0 0-0.1 0-0.1-0.1L733.4-99c-21.7-14.5-44.4-27.6-68-39.3l-265 537.4c0 0-0.1 0-0.1 0l192.6-567.4c-24.6-8.3-49.9-15.1-75.8-20.2L400.2 399c0 0-0.1 0-0.1 0l39.2-597.7c-26.5-1.7-52.7-1.7-78.5-0.1L399.9 399c0 0-0.1 0-0.1 0L282.9-188.6c-25.9 5.1-51.2 11.9-75.8 20.3l192.6 567.4c0 0-0.1 0-0.1 0l-265-537.3c-23.5 11.6-46.2 24.8-67.9 39.3l332.8 498.1c0 0-0.1 0-0.1 0.1L4.4-51.1C-15.3-33.9-33.8-15.3-51.1 4.4l450.4 395c0 0 0 0.1-0.1 0.1L-99 66.6c-14.5 21.7-27.6 44.4-39.3 68l537.4 265c0 0 0 0.1 0 0.1l-567.4-192.6c-8.3 24.6-15.1 49.9-20.2 75.8L399 399.8c0 0 0 0.1 0 0.1l-597.7-39.2c-1.7 26.5-1.7 52.7-0.1 78.5L399 400.1c0 0 0 0.1 0 0.1l-587.6 116.9c5.1 25.9 11.9 51.2 20.3 75.8l567.4-192.6c0 0 0 0.1 0 0.1l-537.3 265c11.6 23.5 24.8 46.2 39.3 67.9l498.1-332.8c0 0 0 0.1 0.1 0.1l-450.4 395c17.3 19.7 35.8 38.2 55.5 55.5l395-450.4c0 0 0.1 0 0.1 0.1L66.6 899c21.7 14.5 44.4 27.6 68 39.3l265-537.4c0 0 0.1 0 0.1 0L207.1 968.3c24.6 8.3 49.9 15.1 75.8 20.2L399.8 401c0 0 0.1 0 0.1 0l-39.2 597.7c26.5 1.7 52.7 1.7 78.5 0.1L400.1 401c0 0 0.1 0 0.1 0l116.9 587.6c25.9-5.1 51.2-11.9 75.8-20.3L400.3 400.9c0 0 0.1 0 0.1 0l265 537.3c23.5-11.6 46.2-24.8 67.9-39.3L400.5 400.8c0 0 0.1 0 0.1-0.1l395 450.4c19.7-17.3 38.2-35.8 55.5-55.5l-450.4-395c0 0 0-0.1 0.1-0.1L899 733.4c14.5-21.7 27.6-44.4 39.3-68l-537.4-265c0 0 0-0.1 0-0.1l567.4 192.6c8.3-24.6 15.1-49.9 20.2-75.8L401 400.2c0 0 0-0.1 0-0.1L998.7 439.2z' />
    </g>
    <text x='50%' y='50%' class='base' dominant-baseline='middle' text-anchor='middle' font-size='8em'>ğŸ¤©</text>
</svg>
```

ä¸€åˆ‡åˆ°äº† `<text>` æ¥è¿‘ SVG ç»“æŸçš„æ—¶å€™éƒ½ä¼šä¿æŒå’Œ EmojiGotchi ä¸€æ ·çš„å¿«ä¹æ°´å¹³å˜åŒ–ã€‚ `<text>` å†…çš„è¡¨æƒ…ç¬¦å·æ˜¯ SVG çš„åŠ¨æ€éƒ¨åˆ†ã€‚ä½ å°†æ ¹æ®è¡¨æƒ…ç¬¦å·çš„å¿«ä¹ç¨‹åº¦æ¥æ›´æ–°å®ƒã€‚

## æ·»åŠ  SVGã€ç»“æ„å’Œæ˜ å°„

å½“æ‚¨åœ¨ä»¤ç‰Œ URI ä¸­å­˜å‚¨è¿™äº›ä¿¡æ¯æ—¶ï¼Œéœ€è¦å¯¹å…¶è¿›è¡Œ base64 ç¼–ç ã€‚OpenZeppelin æä¾›äº†ä¸€ä¸ª [åº“](https://docs.openzeppelin.com/contracts/4.x/api/utils#Base64) æ¥å®Œæˆè¿™ä¸ªã€‚åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæ‚¨å°†ä½¿ç”¨ä¸€ä¸ªé¢„ç¼–ç çš„ SVG ç‰ˆæœ¬ã€‚å°†è¿™äº›å˜é‡æ·»åŠ åˆ°åˆåŒæ­£æ–‡ä¸­ã€‚

```
src/EmojiGotchi.sol

string SVGBase =

'data:image/svg+xml;base64,PHN2ZyB4bWxucz0naHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmcnIHdpZHRoPScxMDAlJyBoZWlnaHQ9JzEwMCUnIHZpZXdCb3g9JzAgMCA4MDAgODAwJz48cmVjdCBmaWxsPScjZmZmZmZmJyB3aWR0aD0nODAwJyBoZWlnaHQ9JzgwMCcvPjxkZWZzPjxyYWRpYWxHcmFkaWVudCBpZD0nYScgY3g9JzQwMCcgY3k9JzQwMCcgcj0nNTAuMSUnIGdyYWRpZW50VW5pdHM9J3VzZXJTcGFjZU9uVXNlJz48c3RvcCAgb2Zmc2V0PScwJyBzdG9wLWNvbG9yPScjZmZmZmZmJy8+PHN0b3AgIG9mZnNldD0nMScgc3RvcC1jb2xvcj0nIzBFRicvPjwvcmFkaWFsR3JhZGllbnQ+PHJhZGlhbEdyYWRpZW50IGlkPSdiJyBjeD0nNDAwJyBjeT0nNDAwJyByPSc1MC40JScgZ3JhZGllbnRVbml0cz0ndXNlclNwYWNlT25Vc2UnPjxzdG9wICBvZmZzZXQ9JzAnIHN0b3AtY29sb3I9JyNmZmZmZmYnLz48c3RvcCAgb2Zmc2V0PScxJyBzdG9wLWNvbG9yPScjMEZGJy8+PC9yYWRpYWxHcmFkaWVudD48L2RlZnM+PHJlY3QgZmlsbD0ndXJsKCNhKScgd2lkdGg9JzgwMCcgaGVpZ2h0PSc4MDAnLz48ZyBmaWxsLW9wYWNpdHk9JzAuNSc+PHBhdGggZmlsbD0ndXJsKCNiKScgZD0nTTk5OC43IDQzOS4yYzEuNy0yNi41IDEuNy01Mi43IDAuMS03OC41TDQwMSAzOTkuOWMwIDAgMC0wLjEgMC0wLjFsNTg3LjYtMTE2LjljLTUuMS0yNS45LTExLjktNTEuMi0yMC4zLTc1LjhMNDAwLjkgMzk5LjdjMCAwIDAtMC4xIDAtMC4xbDUzNy4zLTI2NWMtMTEuNi0yMy41LTI0LjgtNDYuMi0zOS4zLTY3LjlMNDAwLjggMzk5LjVjMCAwIDAtMC4xLTAuMS0wLjFsNDUwLjQtMzk1Yy0xNy4zLTE5LjctMzUuOC0zOC4yLTU1LjUtNTUuNWwtMzk1IDQ1MC40YzAgMC0wLjEgMC0wLjEtMC4xTDczMy40LTk5Yy0yMS43LTE0LjUtNDQuNC0yNy42LTY4LTM5LjNsLTI2NSA1MzcuNGMwIDAtMC4xIDAtMC4xIDBsMTkyLjYtNTY3LjRjLTI0LjYtOC4zLTQ5LjktMTUuMS03NS44LTIwLjJMNDAwLjIgMzk5YzAgMC0wLjEgMC0wLjEgMGwzOS4yLTU5Ny43Yy0yNi41LTEuNy01Mi43LTEuNy03OC41LTAuMUwzOTkuOSAzOTljMCAwLTAuMSAwLTAuMSAwTDI4Mi45LTE4OC42Yy0yNS45IDUuMS01MS4yIDExLjktNzUuOCAyMC4zbDE5Mi42IDU2Ny40YzAgMC0wLjEgMC0wLjEgMGwtMjY1LTUzNy4zYy0yMy41IDExLjYtNDYuMiAyNC44LTY3LjkgMzkuM2wzMzIuOCA0OTguMWMwIDAtMC4xIDAtMC4xIDAuMUw0LjQtNTEuMUMtMTUuMy0zMy45LTMzLjgtMTUuMy01MS4xIDQuNGw0NTAuNCAzOTVjMCAwIDAgMC4xLTAuMSAwLjFMLTk5IDY2LjZjLTE0LjUgMjEuNy0yNy42IDQ0LjQtMzkuMyA2OGw1MzcuNCAyNjVjMCAwIDAgMC4xIDAgMC4xbC01NjcuNC0xOTIuNmMtOC4zIDI0LjYtMTUuMSA0OS45LTIwLjIgNzUuOEwzOTkgMzk5LjhjMCAwIDAgMC4xIDAgMC4xbC01OTcuNy0zOS4yYy0xLjcgMjYuNS0xLjcgNTIuNy0wLjEgNzguNUwzOTkgNDAwLjFjMCAwIDAgMC4xIDAgMC4xbC01ODcuNiAxMTYuOWM1LjEgMjUuOSAxMS45IDUxLjIgMjAuMyA3NS44bDU2Ny40LTE5Mi42YzAgMCAwIDAuMSAwIDAuMWwtNTM3LjMgMjY1YzExLjYgMjMuNSAyNC44IDQ2LjIgMzkuMyA2Ny45bDQ5OC4xLTMzMi44YzAgMCAwIDAuMSAwLjEgMC4xbC00NTAuNCAzOTVjMTcuMyAxOS43IDM1LjggMzguMiA1NS41IDU1LjVsMzk1LTQ1MC40YzAgMCAwLjEgMCAwLjEgMC4xTDY2LjYgODk5YzIxLjcgMTQuNSA0NC40IDI3LjYgNjggMzkuM2wyNjUtNTM3LjRjMCAwIDAuMSAwIDAuMSAwTDIwNy4xIDk2OC4zYzI0LjYgOC4zIDQ5LjkgMTUuMSA3NS44IDIwLjJMMzk5LjggNDAxYzAgMCAwLjEgMCAwLjEgMGwtMzkuMiA1OTcuN2MyNi41IDEuNyA1Mi43IDEuNyA3OC41IDAuMUw0MDAuMSA0MDFjMCAwIDAuMSAwIDAuMSAwbDExNi45IDU4Ny42YzI1LjktNS4xIDUxLjItMTEuOSA3NS44LTIwLjNMNDAwLjMgNDAwLjljMCAwIDAuMSAwIDAuMSAwbDI2NSA1MzcuM2MyMy41LTExLjYgNDYuMi0yNC44IDY3LjktMzkuM0w0MDAuNSA0MDAuOGMwIDAgMC4xIDAgMC4xLTAuMWwzOTUgNDUwLjRjMTkuNy0xNy4zIDM4LjItMzUuOCA1NS41LTU1LjVsLTQ1MC40LTM5NWMwIDAgMC0wLjEgMC4xLTAuMUw4OTkgNzMzLjRjMTQuNS0yMS43IDI3LjYtNDQuNCAzOS4zLTY4bC01MzcuNC0yNjVjMCAwIDAtMC4xIDAtMC4xbDU2Ny40IDE5Mi42YzguMy0yNC42IDE1LjEtNDkuOSAyMC4yLTc1LjhMNDAxIDQwMC4yYzAgMCAwLTAuMSAwLTAuMUw5OTguNyA0MzkuMnonLz48L2c+PHRleHQgeD0nNTAlJyB5PSc1MCUnIGNsYXNzPSdiYXNlJyBkb21pbmFudC1iYXNlbGluZT0nbWlkZGxlJyB0ZXh0LWFuY2hvcj0nbWlkZGxlJyBmb250LXNpemU9JzhlbSc+8J+';

 string[] emojiBase64 = [

 'kqTwvdGV4dD48L3N2Zz4=',

 'YgTwvdGV4dD48L3N2Zz4=',

 'YkDwvdGV4dD48L3N2Zz4=',

 'YoTwvdGV4dD48L3N2Zz4=',

 'SgDwvdGV4dD48L3N2Zz4='

 ];
```

`SVGBase` æ˜¯åŒ…å«ç›´åˆ°è¡¨æƒ…ç¬¦å·æœ¬èº«çš„æ‰€æœ‰ç¼–ç  SVG çš„å­—ç¬¦ä¸²ã€‚

`emojiBase64` æ˜¯ä¸åŒè¡¨æƒ…ç¬¦å·çš„æ•°ç»„ï¼Œå¹¶å…³é—­ SVG å­—ç¬¦ä¸²ã€‚

é™¤äº† SVG å˜é‡ä¹‹å¤–ï¼Œè¿˜éœ€è¦åˆ›å»ºä¸€ä¸ª `struct` ç”¨äº EmojiGotchiã€ `GotchiAttributs` çš„å±æ€§ï¼Œä»¥åŠä¸€ä¸ª NFT æŒæœ‰è€…åˆ°ä»–ä»¬çš„ä»¤ç‰Œ idã€ `gotchiHolders` çš„æ˜ å°„ï¼Œä»¥åŠä¸€ä¸ªä»ä»¤ç‰Œ id åˆ°å±æ€§ã€ `gotchiHolderAttributes` çš„æ˜ å°„ã€‚

```
src/EmojiGotchi.sol

 struct GotchiAttributes {
 uint256 gotchiIndex;
 string imageURI;
 uint256 happiness;
 uint256 hunger;
 uint256 enrichment;
 uint256 lastChecked;
 }

mapping(address => uint256) public gotchiHolders;

mapping(uint256 => GotchiAttributes) public gotchiHolderAttributes;
```

### æ›´æ–°é“¸é€ è¿‡ç¨‹

ä¸‹ä¸€æ­¥æ˜¯æ›´æ–° `safeMint()` å‡½æ•°ï¼Œä»¥åŒ…å«æˆ‘ä»¬éœ€è¦çš„å…ƒæ•°æ®å¹¶å¡«å……æ˜ å°„ã€‚

```
src/EmojiGotchi.sol

function safeMint(address to) public {
 // Grab the current counter
 uint256 tokenId = _tokenIdCounter.current();
 // Increase it
 _tokenIdCounter.increment();
 // Mint the token
 _safeMint(to, tokenId);
 // Set the inital SVG to the first emoji value
 string memory finalSVG = string(abi.encodePacked(SVGBase, emojiBase64[0]));
 // Set attributes for the token to the default
 gotchiHolderAttributes[tokenId] = GotchiAttributes({
 gotchiIndex: tokenId,
 imageURI: finalSVG,
 happiness: 100,
 hunger: 100,
 enrichment: 100,
 lastChecked: block.timestamp
 });
 // Map the token to the holder/minter
 gotchiHolders[msg.sender] = tokenId;
 // Set the URI for the token to include all of the attributes
 _setTokenURI(tokenId, tokenURI(tokenId));

}
```

ä¸€æ—¦ `safeMint()` è¢«æ›´æ–°ï¼Œæ‚¨å°†éœ€è¦æ›´æ–° `tokenURI()` å‡½æ•°çš„è¾“å‡ºï¼Œä»¥åŒ…å«åŸºäºæˆ‘ä»¬å±æ€§çš„æ­£ç¡® JSONã€‚è¿™å¯èƒ½æ˜¯è¿™ä»½åˆåŒä¸­æœ€å…·æŒ‘æˆ˜æ€§çš„éƒ¨åˆ†ã€‚ä¸æ˜¯ä»æŠ€æœ¯çš„è§’åº¦ï¼Œåªæ˜¯ç”±äºåŒ¹é…çš„å¼€å§‹å’Œç»“æŸå¼•å·ã€‚ç»“æœçœ‹èµ·æ¥ä¼šåƒè¿™æ ·ã€‚

```
{
Â Â Â Â "name": "Your Little Emoji Friend",
Â Â Â Â "description": "Keep your pet happy!",
Â Â Â Â "image": <image URI Here>,
Â Â Â Â "traits": [
Â Â Â Â Â Â Â Â {"trait_type": "Hunger", "value": "100"},
Â Â Â Â Â Â Â Â {"trait_type": "Enrichment", "value": "100"},
Â Â Â Â Â Â Â Â {"trait_type": "Happiness", "value": "100"}
Â Â Â Â ]

}
```

æ›´æ–° `tokenURI()` å‡½æ•°ä»¥åŒ…å«å±æ€§å¹¶è¿”å›ä¸€ä¸ª JSON å¯¹è±¡ã€‚

```
src/EmojiGotchi.sol

function tokenURI(uint256 _tokenId)
 public
 view
 override(ERC721, ERC721URIStorage)
 returns (string memory)
{

 // Select the attributes for the token we are referencing
 GotchiAttributes memory gotchiAttributes = gotchiHolderAttributes[_tokenId];

 // The result of this function is a string.
 // Each of these values, happiness, hunger, enrichment
 // is stored as a uint256, they need to be converted to strings
 string memory strHappiness = Strings.toString(gotchiAttributes.happiness);
 string memory strHunger = Strings.toString(gotchiAttributes.hunger);
 string memory strEnrichment = Strings.toString(gotchiAttributes.enrichment);

 // abi.encodePacked is used to combine the strings into a single value.
 string memory json = string(
 abi.encodePacked(
 '{"name": "Your Little Emoji Friend",',
 '"description": "Keep your pet happy!",',
 '"image": "',
 gotchiAttributes.imageURI,
 '",',
 '"traits": [',
 '{"trait_type": "Hunger","value": ',
 strHunger,
 '}, {"trait_type": "Enrichment", "value": ',
 strEnrichment,
 '}, {"trait_type": "Happiness","value": ',
 strHappiness,
 '}]',
 '}'
 )
 );
 return json;
}
```

### è¿”å›è¡¨æƒ…ç¬¦å·çš„ç»Ÿè®¡æ•°æ®

ä¸€æ—¦åˆ›å»ºäº†æ˜ å°„å¹¶æ›´æ–°äº†é“¸å¸å’Œä»¤ç‰Œ URIï¼Œå°±å¯ä»¥æ·»åŠ æˆ‘ä»¬ç”¨ `testURI()` æµ‹è¯•çš„å‡½æ•°äº†ã€‚æµ‹è¯•æ˜¯æœŸæœ›ï¼ŒæŒ‰ç…§è¿™ä¸ªé¡ºåºï¼Œå¹¸ç¦ï¼Œé¥¥é¥¿ï¼Œå……å®ï¼Œæœ€åæ£€æŸ¥ï¼Œå’Œå›¾åƒã€‚è¿™äº›éƒ½å­˜å‚¨åœ¨ä»ä»¤ç‰Œ id åˆ°å±æ€§ `gotchiHolderAttributes` çš„æ˜ å°„ä¸­ã€‚æ‚¨å¯ä»¥ä½¿ç”¨å®ƒæ¥è¿”å›åŸºäºä¼ å…¥çš„ä»¤ç‰Œ id çš„å€¼ã€‚

```
src/EmojiGotchi.sol

function gotchiStats(uint256 _tokenId)
 public
 view
 returns (
 uint256,
 uint256,
 uint256,
 uint256,
 string memory
 )
{
 return (
 gotchiHolderAttributes[_tokenId].happiness,
 gotchiHolderAttributes[_tokenId].hunger,
 gotchiHolderAttributes[_tokenId].enrichment,
 gotchiHolderAttributes[_tokenId].lastChecked,
 gotchiHolderAttributes[_tokenId].imageURI
 );

}
```

ä¸€æ—¦ä½ æ·»åŠ äº†è¿™ä¸ªå‡½æ•°ï¼Œä½ çš„æµ‹è¯•åº”è¯¥ä¼šé€šè¿‡ã€‚

```
â¯ foundry (main) âœ˜ forge test

[â Š] Compiling...
[â °] Compiling 2 files with 0.8.13
[â ”] Solc finished in 294.37ms
Compiler run successful

Running 2 tests for src/test/EmojiGotchi.t.sol:EmojiGotchiTest
[PASS] testMint() (gas: 7844)
[PASS] testUri() (gas: 248121)
Test result: ok. 2 passed; 0 failed; finished in 2.61ms

â¯ foundry (main) âœ˜
```

### å½’æ¥*T3ã€‘è´µ T5EmojiGotchi*

æ¥ä¸‹æ¥çš„æµ‹è¯•å°†çœ‹èµ·æ¥ä¸ `testUri()` ç›¸ä¼¼ï¼Œæœ‰å¾®å°çš„åŒºåˆ«ã€‚åœ¨ `testUri()` ä¸­ï¼Œæ‚¨ä¼ å…¥äº†ä¸€ä¸ª NFT çš„ idã€‚ä½ å°†ä¿®æ”¹å®ƒæ¥è¿”å› `msg.sender` æ‹¥æœ‰çš„è¡¨æƒ…ç¬¦å·çš„å±æ€§ã€‚

```
src/test/EmojiGotchi.t.sol

function testMyGotchi() public {
 (uint256 happiness, uint256 hunger, uint256 enrichment, uint256 checked, ) = eg.myGotchi() ;
 assertEq(happiness, (hunger + enrichment) / 2);
 assertEq(hunger, 100);
 assertEq(enrichment, 100);
 assertEq(checked, block.timestamp);

}
```

è¯¥æµ‹è¯•å°†å¤±è´¥ï¼Œç›´åˆ°æ‚¨æ·»åŠ  `myGotchi()` åŠŸèƒ½ã€‚è¯¥å‡½æ•°å°†é€šè¿‡ `msg.sender` åˆ° `gotchiHolders` çš„æ˜ å°„æ¥è¿”å› EmojiGotchi çš„ id å¹¶æ£€ç´¢å…¶ statsã€‚

```
src/EmojiGotchi.sol

function myGotchi()
Â Â Â Â public
Â Â Â Â view
Â Â Â Â returns (
Â Â Â Â Â Â Â Â uint256,
Â Â Â Â Â Â Â Â uint256,
Â Â Â Â Â Â Â Â uint256,
Â Â Â Â Â Â Â Â uint256,
Â Â Â Â Â Â Â Â string memory
Â Â Â Â )

{
Â Â Â Â return gotchiStats(gotchiHolders[msg.sender]);
}
```

### ä½¿æ—¶é—´æµé€

ç°åœ¨ä½ å·²ç»æœ‰äº†ä¸€ä¸ªåŠŸèƒ½æ€§çš„ NFTï¼Œä½ éœ€è¦è®©æ—¶é—´æµé€ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œè¿™æ„å‘³ç€ä½ å°†éœ€è¦åˆ›å»ºä¸€ä¸ªå‡½æ•°æ¥å‡å°‘ä½ çš„ EmojiGotchi æ˜¯å¦‚ä½•ä¸°å¯Œçš„ã€‚é¦–å…ˆï¼Œæ‚¨åº”è¯¥æ„å»ºæµ‹è¯•ã€‚

```
src/test/EmojiGotchi.t.sol

function testPassTime() public {
 // Pass time for a specific NFT Id
 eg.passTime(0);
 // The empty value is the last time checked and image
 // which we aren't using in this test
 (uint256 happiness, uint256 hunger, uint256 enrichment, , ) = eg.gotchiStats(0);
 // passTime should reduce hunger and enrichment by 10
 assertEq(hunger, 90);
 assertEq(enrichment, 90);
 assertEq(happiness, (90 + 90) / 2);

}
```

ä¸€æ—¦æ·»åŠ äº†æµ‹è¯•ï¼Œæ‚¨çš„æµ‹è¯•åº”è¯¥ä¼šå†æ¬¡å¤±è´¥ã€‚

```
â¯ foundry (main) âœ˜ forge test

[â Š] Compiling...
[â ¢] Compiling 2 files with 0.8.13
[â †] Solc finished in 19.76ms
Error: 
 0: Compiler run failed
TypeError: Member "passTime" not found or not visible after argument-dependent lookup in contract EmojiGotchi.
Â Â Â Â Â Â Â Â --> /Users/rg/Development/EmojiGotchi/foundry/src/test/EmojiGotchi.t.sol:52:9:
Â Â Â Â Â Â Â Â Â |
52 | eg.passTime(0);
Â Â Â Â Â Â Â Â Â | ^^^^^^^^^^^ 

Â Â Â 0:Â 

Location:
 cli/src/compile.rs:88

Backtrace omitted.
Run with RUST_BACKTRACE=1 environment variable to display it.
Run with RUST_BACKTRACE=full to include source snippets.

â¯ foundry (main) âœ˜
```

ä½ éœ€è¦åœ¨ `passTime()` åŠŸèƒ½ä¸­å‡å°‘è¡¨æƒ…çš„é¥¥é¥¿å’Œå……å®å€¼ã€‚ä¸€æ—¦å­˜å‚¨äº†é¥¥é¥¿ã€å¯Œè£•å’Œå¹¸ç¦å±æ€§ï¼Œå°±éœ€è¦æ›´æ–° URIã€‚è¿™æ˜¯è¡¨æƒ…ç¬¦å·æ”¹å˜çš„åœ°æ–¹ã€‚ä½ ä¼šå‚è€ƒå‰é¢è®¾ç½®çš„ `emojiBase64` ã€‚è¿™æ˜¯ä»¥ä¸‹è¡¨æƒ…ç¬¦å·çš„æ•°ç»„:

ğŸ¤©ï¼ŒğŸ˜€ï¼ŒğŸ˜ï¼ŒğŸ˜¡ï¼Œ

æƒ³æƒ³è¿™äº›è¡¨æƒ…ç¬¦å·çš„é€»è¾‘ï¼ŒğŸ¤©& â˜ ï¸ä»£è¡¨æœ€å¤§å¹¸ç¦ï¼Œ100 åˆ†ï¼Œæœ€å°å¹¸ç¦ï¼Œ0 åˆ†ã€‚å¦å¤–ä¸‰ä¸ªï¼ŒğŸ˜€,ğŸ˜ï¼Œ&ğŸ˜¡å°†åˆ†åˆ«åŸºäº 66ã€33 å’Œ 0 ä»¥ä¸Šçš„å¹¸ç¦æ„Ÿã€‚

```
src/EmojiGotchi.sol

function passTime(uint256 _tokenId) public {
 // decrease hunger
 gotchiHolderAttributes[_tokenId].hunger = gotchiHolderAttributes[_tokenId].hunger - 10;
 // decrease enrichment
 gotchiHolderAttributes[_tokenId].enrichment =
 gotchiHolderAttributes[_tokenId].enrichment -
 10;
 // recalculate happiness
 gotchiHolderAttributes[_tokenId].happiness =
 (gotchiHolderAttributes[_tokenId].hunger +
 gotchiHolderAttributes[_tokenId].enrichment) /
 2;
 // update the URI 
 updateURI(_tokenId)
}

function updateURI(uint256 _tokenId) private {
 // store the base case
 string memory emojiB64 = emojiBase64[0];
 // if happiness is 100: ğŸ¤©
 if (gotchiHolderAttributes[_tokenId].happiness == 100) {
 emojiB64 = emojiBase64[0];
 // if happiness is < 100 and > 66 ğŸ˜€
 } else if (gotchiHolderAttributes[_tokenId].happiness > 66) {
 emojiB64 = emojiBase64[1];
 // if happiness is <= 66 and > 33 ğŸ˜
 } else if (gotchiHolderAttributes[_tokenId].happiness > 33) {
 emojiB64 = emojiBase64[2];
 // if happiness is between 33 and greater than 0 ğŸ˜¡
 } else if (gotchiHolderAttributes[_tokenId].happiness > 0) {
 emojiB64 = emojiBase64[3];
 // if your emojigotchi is 'dead' happiness 0 â˜ ï¸
 } else if (gotchiHolderAttributes[_tokenId].happiness == 0) {
 emojiB64 = emojiBase64[4];
 }
 // repack the SVG string with the emoji 
 string memory finalSVG = string(abi.encodePacked(SVGBase, emojiB64));
 //update the attributes for the token
 gotchiHolderAttributes[_tokenId].imageURI = finalSVG;
 // set the token URI to the new values
 _setTokenURI(_tokenId, tokenURI(_tokenId));

}
```

ä¸€æ—¦ä½ æ·»åŠ äº†è¿™äº›åŠŸèƒ½ï¼Œæµ‹è¯•åº”è¯¥ä¼šé‡æ–°é€šè¿‡ã€‚

```
â¯ foundry (main) âœ˜ forge test

[â Š] Compiling...
[â °] Compiling 2 files with 0.8.13
[â ’] Solc finished in 321.33ms
Compiler run successful

Running 4 tests for src/test/EmojiGotchi.t.sol:EmojiGotchiTest
[PASS] testMint() (gas: 7977)
[PASS] testMyGotchi() (gas: 250299)
[PASS] testPassTime() (gas: 806103)
[PASS] testUri() (gas: 248099)
Test result: ok. 4 passed; 0 failed; finished in 3.51ms

â¯ foundry (main) âœ˜
```

### å°½æƒ…äº«å—ä½ çš„è¡¨æƒ…ç¬¦å·

æ—¢ç„¶ä½ å·²ç»åˆ›é€ äº†ä¸€ç§è®©ä½ çš„æƒ…ç»ªå˜å¾—æ— èŠå’Œé¥¥é¥¿çš„æ–¹æ³•ï¼Œä½ éœ€è¦å’Œå®ƒä¸€èµ·ç©ï¼Œå–‚å®ƒã€‚å†æ¬¡ï¼Œä»æµ‹è¯•å¼€å§‹ã€‚è¿™äº›æµ‹è¯•éå¸¸ç›¸ä¼¼ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥åŒæ—¶ç¼–å†™å®ƒä»¬ã€‚

```
src/test/EmojiGotchi.t.sol

function testFeed() public {
 eg.passTime(0);
 eg.feed();
 (uint256 happiness, uint256 hunger, , , ) = eg.gotchiStats(0);
 assertEq(hunger, 100);
 assertEq(happiness, (100 + 90) / 2);
}

function testPlay() public {
 eg.passTime(0);
 eg.play();
 (uint256 happiness, , uint256 enrichment, , ) = eg.gotchiStats(0);
 assertEq(enrichment, 100);
 assertEq(happiness, (90 + 100) / 2);

}
```

ä¸ºäº†æ»¡è¶³è¿™äº›æµ‹è¯•ï¼Œä½ éœ€è¦ä¸€ä¸ª `feed()` å’Œ `play()` å‡½æ•°ï¼Œå°†å®ƒä»¬å„è‡ªçš„å±æ€§è®¾ç½®ä¸º 100 å¹¶é‡æ–°è®¡ç®—å¹¸ç¦åº¦ã€‚

```
src/EmojiGotchi.sol

function feed() public {
 // retrieve the token based on the sender. 
 uint256 _tokenId = gotchiHolders[msg.sender];
 // update hunger
 gotchiHolderAttributes[_tokenId].hunger = 100;
 // recalculate happiness
 gotchiHolderAttributes[_tokenId].happiness =
 (gotchiHolderAttributes[_tokenId].hunger +
 gotchiHolderAttributes[_tokenId].enrichment) /
 2;
 // update the URI based on new attributes
 updateURI(_tokenId);
}

function play() public {
 // retrieve the token based on the sender. 
 uint256 _tokenId = gotchiHolders[msg.sender];
 // update enrichment
 gotchiHolderAttributes[_tokenId].enrichment = 100;
 // recalculate happiness
 gotchiHolderAttributes[_tokenId].happiness =
 (gotchiHolderAttributes[_tokenId].hunger +
 gotchiHolderAttributes[_tokenId].enrichment) /
 2;
 // update the URI based on new attributes
 updateURI(_tokenId);

}
```

ç°åœ¨ä½ å¯ä»¥å’Œä½ çš„è¡¨æƒ…ä¸€èµ·ç©äº†ï¼Œä½ çš„æµ‹è¯•ä¹Ÿå¯ä»¥é€šè¿‡äº†ã€‚

```
â¯ foundry (main) âœ˜ forge test

[â Š] Compiling...
[â °] Compiling 2 files with 0.8.13
[â ’] Solc finished in 330.95ms
Compiler run successful

Running 6 tests for src/test/EmojiGotchi.t.sol:EmojiGotchiTest
[PASS] testFeed() (gas: 890794)
[PASS] testMint() (gas: 7999)
[PASS] testMyGotchi() (gas: 250321)
[PASS] testPassTime() (gas: 806125)
[PASS] testPlay() (gas: 893614)
[PASS] testUri() (gas: 248099)
Test result: ok. 6 passed; 0 failed; finished in 3.87ms

â¯ foundry (main) âœ˜
```

### ç¡®ä¿å›¾åƒ URI æ›´æ–°

å½“ä½ å®ç°äº† `updateURI()` åŠŸèƒ½çš„æ—¶å€™ï¼Œå¹¶æ²¡æœ‰ä¸€ä¸ªæµ‹è¯•æ¥ç¡®ä¿å®ƒèƒ½æ­£å¸¸å·¥ä½œã€‚è™½ç„¶ä»æµ‹è¯•å¼€å‘çš„è§’åº¦æ¥çœ‹ï¼Œè¿™å¯èƒ½æœ‰ç‚¹è½åï¼Œä½†æ˜¯æ‚¨å¯ä»¥å¼¥è¡¥è¿™ä¸ªå·®è·ã€‚

æ‚¨å°†æ·»åŠ ä¸€ä¸ªåŠ©æ‰‹å‡½æ•°æ¥æ¯”è¾ƒå­—ç¬¦ä¸²ï¼Œå¹¶ç¡®ä¿å®ƒä»¬ä¸æ˜¯ç›¸åŒçš„ã€‚åœ¨å¯é æ€§æ–¹é¢ï¼Œæ¯”è¾ƒå­—ç¬¦ä¸²æœ€å¥½é€šè¿‡å°†å®ƒä»¬ç¼–ç æˆä¸€ä¸ªæ•£åˆ—æ¥å®Œæˆã€‚Keccak256 è¿”å›ç”±è¾“å…¥ç¡®å®šçš„ bytes32 å“ˆå¸Œã€‚æ— è®ºè¾“å…¥æ˜¯ä»€ä¹ˆï¼ŒKeccak256 éƒ½å°†è¿”å›ä¸€ä¸ª 64 ä¸ªå­—ç¬¦çš„å€¼ã€‚

```
src/test/EmojiGotchi.t.sol

function compareStringsNot(string memory a, string memory b) public pure returns (bool) {
 return (keccak256(abi.encodePacked((a))) != keccak256(abi.encodePacked((b))));

}
```

ç°åœ¨ï¼Œæ‚¨å¯ä»¥æ·»åŠ ä¸€ä¸ªæµ‹è¯•æ¥ç¡®ä¿ä»¤ç‰Œçš„å›¾åƒåœ¨åº”è¯¥æ”¹å˜çš„æ—¶å€™æ”¹å˜ã€‚

```
src/test/EmojiGotchi.t.sol

function testImgURI() public {
 string memory tokenURI = '';
 (, , , , tokenURI) = eg.gotchiStats(0);
 string memory firstURI = tokenURI;
 eg.passTime(0);
 eg.passTime(0);
 eg.passTime(0);
 (, , , , tokenURI) = eg.gotchiStats(0);
 string memory secondURI = tokenURI;
 assertTrue(compareStringsNot(firstURI, secondURI));

}
```

ä¸€æ—¦è¿™ä¸¤ä¸ªåŠŸèƒ½éƒ½è¢«æ·»åŠ åˆ°æµ‹è¯•å¥‘çº¦ä¸­ï¼Œä½ å°±åº”è¯¥é‡æ–°é€šè¿‡æµ‹è¯•ã€‚

### æµ‹è¯•ä¿å…»

è‡³æ­¤ï¼Œä½ å·²ç»åˆ›å»ºäº†ä¸€ä¸ªåªæœ‰æ‰‹åŠ¨ *æµé€æ—¶é—´* æ—¶æ‰èƒ½ä½“éªŒæ—¶é—´æµé€çš„ EmojiGotchiã€‚ä½¿ç”¨[](https://chain.link/keepers)ï¼Œæ‚¨å°†èƒ½å¤Ÿè‡ªåŠ¨æ‰§è¡Œæ‚¨çš„åˆåŒï¼Œä½¿æ—¶é—´ä»¥å›ºå®šçš„é—´éš”æµé€ã€‚

ä¸ºäº†æµ‹è¯•è¿™ä¸€ç‚¹ï¼Œä½ å°†éœ€è¦ä½¿ç”¨ä¸€ä¸ªç”±ä»£å·¥å‚æä¾›çš„ *æ¬ºéª—ä»£ç * ã€‚åœ¨ `src/test/EmojiGotchi.t.sol` ä¸­å®šä¹‰å¥‘çº¦ä¹‹å‰ï¼Œæ·»åŠ ä»¥ä¸‹æ¥å£ï¼Œå¹¶åœ¨å¥‘çº¦å†…å®ä¾‹åŒ–ã€‚

```
src/test/EmojiGotchi.t.sol

interface CheatCodes {
 function warp(uint256) external;
}

contract EmojiGotchiTest is DSTest {

 CheatCodes constant cheats = CheatCodes(HEVM_ADDRESS);
```

ç„¶åï¼Œåœ¨ EmojiGotchiTest å¥‘çº¦å†…ï¼Œæ·»åŠ å¦ä¸€ä¸ªå‡½æ•° `testUpkeep()` ã€‚

```
src/test/EmojiGotchi.t.sol

function testUpkeep() public {
 bytes memory data = '';
 bool upkeepNeeded = false;
 (upkeepNeeded, ) = eg.checkUpkeep(data);
 assertTrue(upkeepNeeded == false);
 cheats.warp(block.timestamp + 100);
 (upkeepNeeded, ) = eg.checkUpkeep(data);
 assertTrue(upkeepNeeded);

}
```

è¿™ä¸ªæµ‹è¯•ä½¿ç”¨ `cheats.warp` åˆ° *çš„æ—¶é—´æ‰­æ›²* ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¼šéœ€è¦ä¿å…»ã€‚ `checkUpkeep()` å‡½æ•°å°†è¿”å›ä¸€ä¸ªå¸ƒå°”å€¼ï¼Œè®©ç®¡ç†å‘˜ç½‘ç»œçŸ¥é“åˆåŒæ˜¯å¦éœ€è¦ç»´æŠ¤ã€‚

ä¸ºäº†è®©æˆ‘ä»¬çš„ [å¥‘çº¦å…¼å®¹](https://docs.chain.link/docs/chainlink-keepers/compatible-contracts/) ï¼Œæˆ‘ä»¬éœ€è¦ä¸¤ä¸ªå‡½æ•°ã€‚ç¬¬ä¸€ä¸ªæ˜¯ `checkUpkeep()` å®ƒå°†è¿”å›ä¸Šé¢æåˆ°çš„å¸ƒå°”å€¼ï¼›ç¬¬äºŒä¸ªæ˜¯ `performUpkeep()` ï¼Œå®é™…ä¸Šå¯¹åŒºå—é“¾åšäº†ä¿®æ”¹ã€‚æ‚¨å¯ä»¥å°†è¿™ä¸¤è€…æ·»åŠ åˆ°æ‚¨çš„åˆåŒä¸­ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚

```
src/EmojiGotchi.sol

function checkUpkeep(
 bytes calldata /* checkData */
)
 external
 view
 returns (
 bool upkeepNeeded,
 bytes memory /* performData */
 )
{
 // The last time the EmojiGotchi was updated
 uint256 lastTimeStamp = gotchiHolderAttributes[0].lastChecked;
 // If the EmojiGotchi's happiness is > 0 and
 // it's been more than 60s since last check 
 // return true
 // ** NOTE this example hard codes the first token
 // minted for this check. [0] 
 upkeepNeeded = (gotchiHolderAttributes[0].happiness > 0 &&
 (block.timestamp - lastTimeStamp) > 60);
 // We don't use the checkData in this example. The checkData is defined when the Upkeep was registered.
}

function performUpkeep(
 bytes calldata /* performData */
) external {
 uint256 lastTimeStamp = gotchiHolderAttributes[0].lastChecked;
 //We highly recommend revalidating the upkeep in the performUpkeep function
 // Run the same checks as checkUpkeep()
 if (
 gotchiHolderAttributes[0].happiness > 0 &&
 ((block.timestamp - lastTimeStamp) > 60)
 ) {
 // update the last checked value to now
 gotchiHolderAttributes[0].lastChecked = block.timestamp;
 // run passTime
 // ** NOTE this example hard codes the first token
 // minted for this check. [0] 
 passTime(0);
 }
 // We don't use the performData in this example. The performData is generated by the Keeper's call to your checkUpkeep function

}
```

æœ‰äº†è¿™äº›è¡¥å……ï¼Œä½ å°±æœ‰äº†ä¸€ä¸ªåŠŸèƒ½é½å…¨ã€å…¼å®¹å®ˆé—¨å‘˜çš„ NFT è¡¨æƒ…åº“ï¼æ­å–œä½ ï¼

ä½ è¿˜éœ€è¦åœ¨å¥‘çº¦ä¸­æ·»åŠ ä¸€ä¸ªä¸œè¥¿:ä½ éœ€è¦æ·»åŠ ä¸€ä¸ªäº‹ä»¶ï¼Œæ¯æ¬¡è¡¨æƒ…æ›´æ–°æ—¶ä½ éƒ½ä¼šå‘å‡ºè¿™ä¸ªäº‹ä»¶ã€‚åœ¨æ‚¨çš„åˆåŒé¡¶éƒ¨ï¼Œæ·»åŠ äº‹ä»¶å®šä¹‰:

```
src/EmojiGotchi.sol

event EmojiUpdated(
 uint256 happiness,
 uint256 hunger,
 uint256 enrichment,
 uint256 checked,
 string uri,
 uint256 index

);
```

ç„¶åï¼Œæ‚¨å°†éœ€è¦æ·»åŠ ä¸€ä¸ªå‡½æ•°æ¥å®é™…å‘å‡ºæ›´æ–°ï¼Œä»¥åŠæ·»åŠ ä¸€ä¸ªå¯¹ `updateURI()` å‡½æ•°ç»“å°¾çš„è°ƒç”¨ã€‚

æ–°åŠŸèƒ½:

```
src/EmojiGotchi.sol

function emitUpdate(uint256 _tokenId) internal {
 emit EmojiUpdated(
 gotchiHolderAttributes[_tokenId].happiness,
 gotchiHolderAttributes[_tokenId].hunger,
 gotchiHolderAttributes[_tokenId].enrichment,
 gotchiHolderAttributes[_tokenId].lastChecked,
 gotchiHolderAttributes[_tokenId].imageURI,
 _tokenId
 );

}
```

æ”¹å˜ `updateURI()` æ¥åæ˜ è¿™ä¸ªæ–°äº‹ä»¶çš„åŠ å…¥ã€‚

```
function updateURI(uint256 _tokenId) private {
Â Â Â Â // store the base case
Â Â Â Â string memory emojiB64 = emojiBase64[0];
Â Â Â Â // if happiness is 100: ğŸ¤©
Â Â Â Â if (gotchiHolderAttributes[_tokenId].happiness == 100) {
Â Â Â Â Â Â Â Â emojiB64 = emojiBase64[0];
Â Â Â Â Â Â Â Â // if happiness is < 100 and > 66 ğŸ˜€
} else if (gotchiHolderAttributes[_tokenId].happiness > 66) {
Â Â Â Â Â Â Â Â emojiB64 = emojiBase64[1];
Â Â Â Â Â Â Â Â // if happiness is <= 66 and > 33 ğŸ˜
} else if (gotchiHolderAttributes[_tokenId].happiness > 33) {
Â Â Â Â Â Â Â Â emojiB64 = emojiBase64[2];
Â Â Â Â Â Â Â Â // if happiness is between 33 and greater than 0 ğŸ˜¡
} else if (gotchiHolderAttributes[_tokenId].happiness > 0) {
Â Â Â Â Â Â Â Â emojiB64 = emojiBase64[3];
Â Â Â Â Â Â Â Â // if your emojigotchi is 'dead' happiness 0 â˜ ï¸
} else if (gotchiHolderAttributes[_tokenId].happiness == 0) {
Â Â Â Â Â Â Â Â emojiB64 = emojiBase64[4];
 }
Â Â Â Â // repack the SVG string with the emoji
Â Â Â Â string memory finalSVG = string(abi.encodePacked(SVGBase, emojiB64));
Â Â Â Â //update the attributes for the token
Â Â Â Â gotchiHolderAttributes[_tokenId].imageURI = finalSVG;
Â Â Â Â // set the token URI to the new values
Â Â Â Â _setTokenURI(_tokenId, tokenURI(_tokenId));
Â Â Â Â emitUpdate(_tokenId);

}
```

### åˆåŒå®Œæˆï¼

ä½ åšåˆ°äº†ï¼åˆåŒå·²å‡†å¤‡å¥½éƒ¨ç½²ï¼æ‚¨å¯ä»¥ä½¿ç”¨ `foundry` ç›®å½•ä¸­çš„ `deploy.sh` æ¥éƒ¨ç½²æ‚¨çš„ NFT åˆåŒã€‚å¦‚æœæ‚¨æƒ³åœ¨éƒ¨ç½²æ—¶ä¸ºè‡ªå·±åˆ›å»ºä¸€ä¸ª NFTï¼Œè¯·å°†ä»¥ä¸‹å†…å®¹æ·»åŠ åˆ°æ„é€ å‡½æ•°ä¸­ã€‚

```
/src/EmojiGotchi.sol

constructor() ERC721("EmojiGotchi", "emg") {
Â Â Â Â safeMint(msg.sender);

}
```

ä¸€æ—¦æ‚¨è¿è¡Œ `deploy.sh` ï¼Œæ‚¨åº”è¯¥ä¼šçœ‹åˆ°æ‚¨çš„åˆåŒä» **éƒ¨ç½²åˆ°** ã€‚åœ¨ä¸‹ä¸€èŠ‚ä¸­ï¼Œæˆ‘ä»¬å°†æ„å»ºå‰ç«¯ï¼Œæ‚¨å°†éœ€è¦è¿™ä¸ªåœ°å€ã€‚

```
Deployer: 0x0000000000000000000000000000000000000000
Deployed to: 0x1234567890123456789012345678901234567890

Transaction hash: 0x1234567890123456789012345678901234567890594be2f670606ada53412aaa
```

## æ„å»ºä¸€ä¸ªè‹—æ¡çš„å‰ç«¯

æœ¬æ•™ç¨‹çš„ç¬¬äºŒéƒ¨åˆ†å°†å¸¦ä½ ä¸ºè¡¨æƒ…ç¬¦å·æ„å»ºä¸€ä¸ªåŸºäº SvelteKit çš„å‰ç«¯ã€‚æœ¬æ•™ç¨‹ä¾§é‡äºåŠŸèƒ½ï¼Œå°†ç”±æ‚¨æ¥é€‰æ‹©è®¾è®¡ã€‚

### è‹—æ¡çš„éª¨æ¶

èµ·å§‹é¡¹ç›®ä» [å¼€å§‹ï¼ŒåŒ…æ‹¬æ·»åŠ ](https://kit.svelte.dev/) [é†š](https://ethers.org/) éª¨æ¶é¡¹ç›®ã€‚ä¸ºäº†å¼€å§‹ï¼Œä½ éœ€è¦å®‰è£… `svelte` ç›®å½•ä¸‹çš„æ‰€æœ‰ä¸œè¥¿

```
â¯ svelte (main) âœ” npm install

> [[emailÂ protected]](/cdn-cgi/l/email-protection) prepare
> svelte-kit sync

added 209 packages, and audited 210 packages in 1s

53 packages are looking for fundin
run `npm fund` for details

found 0 vulnerabilities

â¯ svelte (main) âœ”
```

æ­¤æ—¶ï¼Œæ‚¨åº”è¯¥èƒ½å¤Ÿå¯åŠ¨ Svelte æœåŠ¡å™¨ï¼Œå¹¶çœ‹åˆ°æ¬¢è¿ä½¿ç”¨ SvelteKit é¡µé¢ã€‚

```
â¯ svelte (main) âœ” npm run dev

> [[emailÂ protected]](/cdn-cgi/l/email-protection) dev
> svelte-kit dev

Â Â SvelteKit v1.0.0-next.325

 local: Â  http://localhost:3000
 network: not exposed

Â Â Use --host to expose server to other devices on this network
```

![Image showing Welcome to SvelteKit](../Images/75a79cb58a7f4c9e9ff74317a7d1a328.png)

SvelteKit å°†çƒ­é‡æ–°åŠ è½½æ‚¨å¯¹ `src/routes/index.svelte` æ‰€åšçš„ä»»ä½•æ›´æ”¹ï¼Œå¦‚æœæ‚¨æ›´æ”¹è¯¥æ–‡ä»¶ï¼Œå®ƒå°†ä¼šåæ˜ åœ¨æ‚¨çš„æµè§ˆå™¨ä¸­ã€‚

```
src/routes/index.svelte

<h1>My EmojiGotchi</h1>

This is where you can see your EmojiGotchi.
```

![Image showing webpage titled My EmojiGotchi](../Images/4bd1f0f6bd7790cf709b574de8023567.png)

å¯åŠ¨å¹¶è¿è¡Œåï¼Œä½ å¯ä»¥åˆ›å»ºä½ çš„ç¬¬ä¸€ä¸ªç»„ä»¶ã€‚

### è¿æ¥æ‚¨çš„é’±åŒ…

ä½ éœ€è¦åœ¨ `src/lib` ç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ªç»„ä»¶ã€‚ä¸ºäº†ç®€å•åœ°å¼€å§‹å¹¶ç¡®ä¿ä¸€åˆ‡æ­£å¸¸ï¼Œç°åœ¨åªéœ€åœ¨ç»„ä»¶ä¸­åˆ›å»ºä¸€ä¸ªæŒ‰é’®ã€‚

```
src/lib/WalletConnect.svelte

<button>Attach Wallet</button>
```

ç„¶ååœ¨ `src/routes/index.svelte` `å†…å°±å¯ä»¥å¯¼å…¥è¿™ä¸ªæ–°ç»„ä»¶äº†ã€‚åœ¨å®Œå…¨å……å®ç»„ä»¶ä¹‹å‰ï¼Œç¡®ä¿ç»„ä»¶è¢«æ­£ç¡®å¯¼å…¥æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„å®è·µã€‚å®ƒè¿˜å…è®¸æ‚¨åœ¨é€šè¿‡çƒ­é‡è£…æ„å»ºç»„ä»¶æ—¶æŸ¥çœ‹å¢é‡æ›´æ”¹ã€‚`

 ````
src/routes/index.svelte

<script>
 import WalletConnect from '$lib/WalletConnect.svelte';
</script>

<h1>My EmojiGotchi</h1>

<WalletConnect />
```

è¿™å°†ä¸ºæ‚¨çš„é¡µé¢æä¾›ä»¥ä¸‹æ›´æ”¹ã€‚

![Image of webpage showing where to attach wallet for My EmojiGotchi](../Images/152e1dc1af734e47a90ec7b6011fbecb.png)

ä¸€æ—¦è¿™ä¸ªå·¥ä½œæ­£å¸¸ï¼Œæˆ‘ä»¬å°±å¯ä»¥æ„å»ºå…¶ä½™çš„ç»„ä»¶äº†ã€‚æˆ‘ä¸ä¼šç»§ç»­æ¼”ç¤ºè¿™äº›æ­¥éª¤ï¼Œä½†æ˜¯è¯·è®°ä½åœ¨å¯¼å…¥ä¹‹å‰åˆ›å»ºç»„ä»¶ã€‚

ä¸ºäº†åœ¨ç»„ä»¶ä¹‹é—´ä¼ é€’å¥‘çº¦å’Œé’±åŒ…ï¼Œæ‚¨éœ€è¦åˆ›å»ºä¸€ä¸ªå­˜å‚¨å®ƒä»¬çš„åœ°æ–¹ã€‚æ‚¨å¯ä»¥åˆ›å»ºä¸€ä¸ª `web3Props` å¯¹è±¡æ¥ä¿å­˜è¿™äº›ä¿¡æ¯ã€‚

```
src/lib/WalletConnect.svelte

<script>
 import { ethers } from 'ethers';
 // place holder for the properties we will be passing between components
 export let web3Props = { provider: null, signer: null, account: null, chainId: null };
 // connect the wallet
 async function connectWallet() {
 // get the provider, this time without ethereum object
 let provider = new ethers.providers.Web3Provider(window.ethereum, 'any');
 // prompt user for account connections
 await provider.send('eth_requestAccounts', []);
 // get the signer
 const signer = provider.getSigner();
 // get the account address
 const account = await signer.getAddress();
 // get the chainId
 const chainId = await signer.getChainId();
 // update the props
 web3Props = { signer, provider, chainId, account };
 }
</script>

<button on:click={connectWallet}>Attach Wallet</button>
```

ç»„ä»¶æ›´æ–°åï¼Œæ‚¨éœ€è¦å°†é“å…·ä» `index.svelte` ä¼ é€’åˆ°ç»„ä»¶ä¸­ã€‚

```
src/routes/index.svelte

<script>
 import WalletConnect from '$lib/WalletConnect.svelte'; 
 export let web3Props = {
 provider: null,
 signer: null, 
 account: null,
 chainId: null
 };
</script>

<h1>My EmojiGotchi</h1>
{#if !web3Props.account}
 <WalletConnect bind:web3Props />
{:else}
 ğŸ˜
{/if}
```

![Gif showing how to use MetaMask with the app.](../Images/184e7ea00a5414f404d36c29761a8671.png)

### æ·»åŠ æ‚¨çš„åˆåŒ

ç°åœ¨æ‚¨å·²ç»èƒ½å¤Ÿå°†é’±åŒ…é™„åŠ åˆ°æ‚¨çš„å‰ç«¯ï¼Œæ‚¨å°†éœ€è¦å¯¼å…¥åˆåŒä¿¡æ¯ã€‚ç¬¬ä¸€æ­¥æ˜¯åˆ›å»ºä¸€ä¸ªæ–°ç›®å½•ï¼Œ `src/contracts` ï¼Œå®ƒå°†å­˜æ”¾æ‚¨çš„åˆåŒçš„ JSON ABIã€‚å¦‚æœä½ å¤´å› `foundry` ç›®å½•ä¸‹çš„ `foundry/out/EmojiGotchi.sol` ä½ ä¼šå‘ç° `EmojiGotchi.json` ã€‚å°†æ­¤æ–‡ä»¶å¤åˆ¶åˆ° `src/contracts` é¡¹ç›®çš„ `svelte` éƒ¨åˆ†å†…ã€‚

è¿™ä¸ªæ–‡ä»¶å­˜æ”¾äº†ä½ çš„åˆåŒçš„ ABIã€‚æ‚¨éœ€è¦å¯¼å…¥å®ƒå¹¶å°†ä¿¡æ¯æ·»åŠ åˆ° `web3Props` ä»¥åŠ `WalletConnect` ç»„ä»¶ä¸­ã€‚æ­¤å¤–ï¼Œæ‚¨éœ€è¦ä¸ºåˆåŒåœ°å€æ·»åŠ ä¸€ä¸ªå¸¸é‡ã€‚è¿™å°±æ˜¯éƒ¨ç½²ä¸Šè¿°åˆåŒçš„ä»·å€¼ã€‚

```
src/routes/index.svelte

<script>
 // new import
 import EmojiGotchiAbi from '../contracts/EmojiGotchi.json';
 // new constant for contract address
 const contractAddr = '<PLACE HOLDER>';

 export let web3Props = {
 provider: null,
 signer: null,
 account: null,
 chainId: null,
 // new prop contract: null
 };
</script>
{#if !web3Props.account}
 // new values passed to component
 <WalletConnect bind:web3Props {contractAddr} contractAbi={EmojiGotchiAbi} />
{:else}
 ğŸ˜
{/if} 
```

```
src/lib/WalletConnect.svelte

<script>
 import { ethers } from 'ethers';
 export let web3Props = {
 provider: null,
 signer: null,
 account: null, 
 chainId: null,
 // new prop
 contract: null
 };
 // new variable for the contract address
 export let contractAddr = '';
 // new variable for the contract ABI
 export let contractAbi = { abi: null };

 async function connectWallet() {
 let provider = new ethers.providers.Web3Provider(window.ethereum, 'any');
 await provider.send('eth_requestAccounts', []);
 const signer = provider.getSigner();
 const account = await signer.getAddress();
 const chainId = await signer.getChainId();
 // new contract variable
 const contract = new ethers.Contract(contractAddr, contractAbi.abi, signer);
 // new value for contract
 web3Props = { signer, provider, chainId, account, contract };
 }
</script>

<button on:click={connectWallet}>Attach Wallet</button>
```

å¦™æäº†ï¼æ­¤æ—¶ï¼Œæ‚¨çš„é’±åŒ…å·²ç»è¿æ¥åˆ°åŒºå—é“¾ï¼Œå¹¶ä¸”æ‚¨å·²ç»å‡†å¤‡å¥½äº†æ‰€æœ‰çš„åˆåŒä¿¡æ¯ã€‚è®©æˆ‘ä»¬æ„å»º EmojiGotchi æ¥å£ã€‚

### æ„å»º EmojiGotchi ç»„ä»¶

çœ‹çœ‹æˆ‘ä»¬æ­£åœ¨åŠªåŠ›çš„æœ€ç»ˆç»“æœï¼Œæˆ‘ä»¬éœ€è¦æ„å»ºä¸€äº›ä¸œè¥¿ï¼Œè¡¨æƒ…å›¾æ ‡ã€è¿›åº¦æ¡ã€å€¼å’Œå‡ ä¸ªæŒ‰é’®ã€‚

![Gif showing My EmojiGotchi app](../Images/08d616a21e8cd719affc8863bd422b9d.png)

é¦–å…ˆï¼Œä½ å°†æ„å»ºå‡ ä¸ªå­ç»„ä»¶ã€‚ä½ å°†ä»å»ºç«‹ä½ çš„è¡¨æƒ…å¼€å§‹ã€‚

```
src/lib/Face.svelte

<script>
 export let image;
</script>

<img src={image} alt="Your EmojiGotchi" />
```

è¿™æ˜¯ä¸€ä¸ªéå¸¸ç®€å•çš„ç»„ä»¶ï¼Œå®ƒæ¥æ”¶ä¸€ä¸ªå›¾åƒï¼Œåœ¨è¿™ä¸ªä¾‹å­ä¸­æ˜¯ä¸€ä¸ª base64 ç¼–ç çš„ SVGï¼Œå¹¶æ˜¾ç¤ºå®ƒã€‚

æ¥ä¸‹æ¥ï¼Œæ‚¨å¯ä»¥æ„å»ºè¿›åº¦æ¡ç»„ä»¶æ¥æ˜¾ç¤ºè¿˜å‰©å¤šå°‘å¿«ä¹æˆ–å……å®ã€‚

```
src/lib/Bar.svelte

<script>
 export let status;
</script>



<style>
 .status {
 height: 8px;
 background: blue;
 width: 33%;
 }

</style>
```

æœ‰äº†è¿™ä¸¤ä¸ªç»„ä»¶ï¼Œä½ å°±èƒ½å¤Ÿæ„å»ºå®Œæ•´çš„ EmojiGotchi ç»„ä»¶äº†ã€‚

```
src/lib/EmojiGotchi.svelte

<script>
 import Bar from './Bar.svelte';
 import Face from './Face.svelte';
 export let web3Props = {
 provider: null,
 signer: null,
 account: null,
 chainId: null,
 contract: null
 };
 // set placeholders for variables
 // $: in svelte denotes a reactive declaration
 // it will be updated when the value changes
 $: image = '';
 $: hunger = 0;
 $: enrichment = 0;
 $: happiness = 0;
 const getMyGotchi = async () => {
 // get the contract instance let currentGotchi = await web3Props.contract.myGotchi();
 // get the current gotchi's image
 image = await currentGotchi[4];
 // get the current gotchi's happiness
 happiness = await currentGotchi[0].toNumber();
 // get the current gotchi's hunger
 hunger = await currentGotchi[1].toNumber();
 // get the current gotchi's enrichment
 enrichment = await currentGotchi[2].toNumber();
 // Listen for the EmojiUpdated event and update the values
 web3Props.contract.on('EmojiUpdated', async () => {
 currentGotchi = await web3Props.contract.myGotchi();
 image = await currentGotchi[4];
 happiness = await currentGotchi[0].toNumber();
 hunger = await currentGotchi[1].toNumber();
 enrichment = await currentGotchi[2].toNumber();
 });
 };
 getMyGotchi();
</script>


 <Face {image} />


 Hunger: {hunger}
 <br />
 <Bar bind:status={hunger} />
 <button
 on:click={() => {
 web3Props.contract.feed();
 }}>Feed</button
 >


 Enrichment: {enrichment}
 <br />
 <Bar bind:status={enrichment} />
 <button
 on:click={() => {
 web3Props.contract.play();
 }}>Play</button
 >


 Happiness: {happiness}
 <Bar bind:status={happiness} />


<style>
 div {
 width: 33%;
 }

</style>
```

### è¿æ¥ EmojiGotchi ç»„ä»¶

å¦‚æœè¿˜æ²¡æœ‰ï¼Œæœ€åä¸€æ­¥å°±æ˜¯æŠŠè¿™ä¸ªç»„ä»¶æ·»åŠ åˆ° `index.svelte` ã€‚

```
<script>
 import EmojiGotchiAbi from '../contracts/EmojiGotchi.json';
 import WalletConnect from '$lib/WalletConnect.svelte';
 import EmojiGotchi from '../lib/EmojiGotchi.svelte'; 
 const contractAddr = '<PLACE HOLDER>';
 export let web3Props = {
 provider: null,
 signer: null,
 account: null,
 chainId: null,
 contract: null
 };
</script>

<h1>My EmojiGotchi</h1>
{#if !web3Props.account}
 <WalletConnect bind:web3Props {contractAddr} contractAbi={EmojiGotchiAbi} />
{:else}
 <EmojiGotchi bind:web3Props />
{/if}
```

## è®©å®ƒå……æ»¡æ´»åŠ›

ç°åœ¨ä½ æœ‰äº†ä¸€ä¸ªå®Œæ•´çš„ dAppï¼Œè¿˜æœ‰æœ€åä¸€æ­¥ã€‚ä½ éœ€è¦å‰å¾€[](https://keepers.chain.link)**æ³¨å†Œä¸€ä¸ªæ–°çš„ç»´æŒè´¹** ã€‚å¡«å†™ç›¸å…³ä¿¡æ¯å¹¶æäº¤æ‚¨çš„ç»´æŠ¤è´¹ã€‚å½“ä½ çœ‹ä½ çš„è¡¨æƒ…ç¬¦å·æ—¶ï¼Œä½ ä¼šçœ‹åˆ°å®ƒçš„å±æ€§åœ¨å‡å°‘ã€‚ä¸€å®šè¦è®©å®ƒå¼€å¿ƒï¼

è®¿é—®[chain . link](https://chain.link/)æˆ–é˜…è¯»[docs . chain . link](https://docs.chain.link/)ä¸Šçš„æ–‡æ¡£ï¼Œäº†è§£æ›´å¤šå…³äº Chainlink çš„ä¿¡æ¯ã€‚ [è¦è®¨è®ºä¸€ä¸ªé›†æˆï¼Œå°±å»æ‰¾ä¸“å®¶ã€‚](https://chainlinkcommunity.typeform.com/to/OYQO67EF)``